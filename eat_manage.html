<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒä»€ä¹ˆ - éšæœºé€‰æ‹©é¤å…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .add-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"],
        input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .random-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .random-section button {
            background: white;
            color: #f5576c;
            font-size: 20px;
            font-weight: bold;
            padding: 15px 40px;
        }

        .result {
            margin-top: 20px;
            font-size: 2em;
            color: white;
            font-weight: bold;
            min-height: 50px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .vendor-list {
            display: grid;
            gap: 10px;
            max-height: 750px;
            overflow-y: auto;
        }

        .vendor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .vendor-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .vendor-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .vendor-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .vendor-weight {
            font-size: 14px;
            color: #666;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .vendor-item.zero-weight {
            opacity: 0.7;
        }

        .vendor-item.zero-weight .vendor-name,
        .vendor-item.zero-weight .vendor-weight {
            color: #999;
        }

        .vendor-item.zero-weight .vendor-weight {
            background: #f1f3f5;
        }

        .vendor-actions {
            display: flex;
            gap: 8px;
        }

        .weight-edit-input {
            width: 80px;
            padding: 5px 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
        }

        .name-edit-input {
            width: 200px;
            padding: 5px 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
        }

        .edit-btn {
            background: #28a745;
            padding: 8px 16px;
            font-size: 14px;
        }

        .edit-btn:hover {
            background: #218838;
        }

        .save-btn {
            background: #007bff;
            padding: 8px 16px;
            font-size: 14px;
        }

        .save-btn:hover {
            background: #0056b3;
        }

        .cancel-btn {
            background: #6c757d;
            padding: 8px 16px;
            font-size: 14px;
        }

        .cancel-btn:hover {
            background: #545b62;
        }

        .delete-btn {
            background: #dc3545;
            padding: 8px 16px;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }

        .export-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-section button {
            flex: 1;
        }

        .sort-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sort-control label {
            color: #666;
            font-size: 14px;
            font-weight: normal;
        }

        .sort-control select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .sort-control select:focus {
            outline: none;
            border-color: #667eea;
        }

        .sort-control select:hover {
            border-color: #764ba2;
        }

        .meal-item {
            display: grid;
            grid-template-columns: 100px 1fr 100px 80px auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .meal-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .meal-date {
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        .meal-order {
            font-size: 16px;
            color: #333;
        }

        .meal-price {
            font-size: 16px;
            color: #28a745;
            font-weight: bold;
        }

        .meal-rate {
            font-size: 14px;
            color: #ff9800;
        }

        .meal-actions {
            display: flex;
            gap: 8px;
        }

        input[type="date"] {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .date-edit-input {
            width: 100px;
            padding: 5px 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
        }

        .order-edit-input {
            width: 100%;
            padding: 5px 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
        }

        .price-edit-input {
            width: 80px;
            padding: 5px 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
        }

        .rate-edit-input {
            width: 60px;
            padding: 5px 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ½ï¸ åƒä»€ä¹ˆ</h1>

        <div class="random-section">
            <button onclick="randomSelect()">ğŸ² éšæœºé€‰æ‹©ä¸€å®¶é¤å…</button>
            <div class="result" id="result"></div>
        </div>

        <div class="section">
            <h2>â• æ·»åŠ å•†å®¶</h2>
            <div class="add-form">
                <input type="text" id="vendorName" placeholder="å•†å®¶åç§°" />
                <input type="number" id="vendorWeight" placeholder="æƒé‡" value="100" min="0" />
                <button onclick="addVendor()">æ·»åŠ </button>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ å•†å®¶åˆ—è¡¨ <span id="totalWeight" style="font-size: 0.8em; color: #666;"></span></h2>
            <div class="sort-control">
                <label for="sortSelect">æ’åºæ–¹å¼ï¼š</label>
                <select id="sortSelect" onchange="changeSortOrder()">
                    <option value="default">é»˜è®¤é¡ºåº</option>
                    <option value="name">æŒ‰åç§°æ’åº</option>
                    <option value="weight">æŒ‰æƒé‡æ’åº</option>
                </select>
            </div>
            <div class="vendor-list" id="vendorList"></div>
        </div>

        <div class="section">
            <h2>ğŸœ æ·»åŠ ç‚¹é¤è®°å½•</h2>
            <div class="add-form">
                <input type="date" id="mealDate" />
                <input type="text" id="mealOrder" placeholder="ç‚¹é¤å†…å®¹" />
                <input type="number" id="mealPrice" placeholder="ä»·æ ¼" step="0.01" min="0" />
                <input type="number" id="mealRate" placeholder="è¯„ä»·(1-5)" min="1" max="5" value="3" />
                <button onclick="addMeal()">æ·»åŠ </button>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ ç‚¹é¤è®°å½•</h2>
            <div class="vendor-list" id="mealList"></div>
        </div>
    </div>

    <script>
        let vendors = [];
        let originalVendors = []; // ä¿å­˜åŸå§‹é¡ºåº
        let currentSortOrder = 'default'; // å½“å‰æ’åºæ–¹å¼
        let meals = []; // ç‚¹é¤è®°å½•
        // Use relative URL for Cloudflare Tunnel compatibility
        const API_URL = window.location.origin + '/api';

        function loadData() {
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦æ˜¯åŒ—äº¬æ—¶é—´æ˜ŸæœŸå››ï¼Œå¹¶è‡ªåŠ¨è®¾å®šKè®°çš„æƒé‡
            checkAndSetKJiWeight();

            // åŠ è½½å•†å®¶æ•°æ®
            fetch(API_URL + '/vendors')
                .then(response => response.json())
                .then(data => {
                    originalVendors = data; // ä¿å­˜åŸå§‹é¡ºåº
                    vendors = data;

                    // ä»localStorageæ¢å¤æ’åºæ–¹å¼
                    const savedSortOrder = localStorage.getItem('sortOrder');
                    if (savedSortOrder) {
                        currentSortOrder = savedSortOrder;
                        document.getElementById('sortSelect').value = savedSortOrder;
                        applySortOrder();
                    }

                    renderVendorList();
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
                });

            // åŠ è½½ç‚¹é¤è®°å½•æ•°æ®
            fetch(API_URL + '/meals')
                .then(response => response.json())
                .then(data => {
                    meals = data;
                    renderMealList();
                })
                .catch(error => {
                    console.error('Error loading meals:', error);
                    alert('åŠ è½½ç‚¹é¤è®°å½•å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
                });
        }

        // æ£€æŸ¥ä»Šå¤©æ˜¯å¦æ˜¯åŒ—äº¬æ—¶é—´æ˜ŸæœŸå››ï¼Œå¹¶è‡ªåŠ¨è®¾å®šKè®°çš„æƒé‡
        function checkAndSetKJiWeight() {
            // è·å–åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const beijingTime = new Date(utc + (3600000 * 8));

            // è·å–æ˜ŸæœŸå‡ ï¼ˆ0=æ˜ŸæœŸæ—¥, 1=æ˜ŸæœŸä¸€, ..., 4=æ˜ŸæœŸå››ï¼‰
            const dayOfWeek = beijingTime.getDay();

            // æ ¹æ®æ˜¯å¦æ˜¯æ˜ŸæœŸå››è®¾å®šæƒé‡
            const weight = (dayOfWeek === 4) ? 3000 : 100;

            // å‘é€è¯·æ±‚æ›´æ–°Kè®°çš„æƒé‡
            fetch(API_URL + '/vendors/0', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ vendor: 'Kè®°', weight: weight })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.log('è‡ªåŠ¨è®¾å®šKè®°æƒé‡å¤±è´¥:', data.error);
                } else {
                    console.log('å·²è‡ªåŠ¨è®¾å®šKè®°æƒé‡ä¸º:', weight, '(ä»Šå¤©æ˜¯' + (dayOfWeek === 4 ? 'æ˜ŸæœŸå››' : 'éæ˜ŸæœŸå››') + ')');
                }
            })
            .catch(error => {
                console.error('Error setting Kè®° weight:', error);
            });
        }

        function addVendor() {
            const nameInput = document.getElementById('vendorName');
            const weightInput = document.getElementById('vendorWeight');

            const name = nameInput.value.trim();
            const weight = parseInt(weightInput.value);

            if (!name) {
                alert('è¯·è¾“å…¥å•†å®¶åç§°ï¼');
                return;
            }

            if (Number.isNaN(weight) || weight < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æƒé‡ï¼ˆå¤§äºç­‰äº0çš„æ•´æ•°ï¼‰ï¼');
                return;
            }

            fetch(API_URL + '/vendors', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ vendor: name, weight: weight })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    originalVendors = data.vendors;
                    vendors = data.vendors;
                    applySortOrder();
                    renderVendorList();
                    nameInput.value = '';
                    weightInput.value = '100';
                    nameInput.focus();
                }
            })
            .catch(error => {
                console.error('Error adding vendor:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
            });
        }

        function deleteVendor(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤ "' + vendors[index].vendor + '" å—ï¼Ÿ')) {
                fetch(API_URL + '/vendors/' + index, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        originalVendors = data.vendors;
                        vendors = data.vendors;
                        applySortOrder();
                        renderVendorList();
                    }
                })
                .catch(error => {
                    console.error('Error deleting vendor:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
                });
            }
        }

        function renderVendorList() {
            const listContainer = document.getElementById('vendorList');
            const totalWeightElement = document.getElementById('totalWeight');

            if (vendors.length === 0) {
                listContainer.innerHTML = '<div class="empty-message">æš‚æ— å•†å®¶ï¼Œè¯·å…ˆæ·»åŠ å•†å®¶</div>';
                totalWeightElement.textContent = '';
                return;
            }

            // è®¡ç®—æƒé‡æ€»å’Œ
            const totalWeight = vendors.reduce(function(sum, vendor) {
                return sum + vendor.weight;
            }, 0);

            // æ›´æ–°å•†å®¶æ•°é‡å’Œæƒé‡æ€»å’Œæ˜¾ç¤º
            totalWeightElement.textContent = '(å•†å®¶æ•°é‡: ' + vendors.length + ', æ€»æƒé‡: ' + totalWeight + ')';

            listContainer.innerHTML = vendors.map(function(vendor, index) {
                const zeroClass = vendor.weight === 0 ? ' zero-weight' : '';
                return '<div class="vendor-item' + zeroClass + '" id="vendor-' + index + '">' +
                    '<div class="vendor-info">' +
                    '<span class="vendor-name" id="name-display-' + index + '">' + vendor.vendor + '</span>' +
                    '<input type="text" class="name-edit-input" id="name-input-' + index + '" value="' + vendor.vendor + '" style="display: none;" />' +
                    '<span class="vendor-weight" id="weight-display-' + index + '">æƒé‡: ' + vendor.weight + '</span>' +
                    '<input type="number" class="weight-edit-input" id="weight-input-' + index + '" value="' + vendor.weight + '" min="0" style="display: none;" />' +
                    '</div>' +
                    '<div class="vendor-actions">' +
                    '<button class="edit-btn" id="edit-btn-' + index + '" onclick="editVendor(' + index + ')">ç¼–è¾‘</button>' +
                    '<button class="save-btn" id="save-btn-' + index + '" onclick="saveVendor(' + index + ')" style="display: none;">ä¿å­˜</button>' +
                    '<button class="cancel-btn" id="cancel-btn-' + index + '" onclick="cancelEdit(' + index + ')" style="display: none;">å–æ¶ˆ</button>' +
                    '<button class="delete-btn" onclick="deleteVendor(' + index + ')">åˆ é™¤</button>' +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        function editVendor(index) {
            document.getElementById('name-display-' + index).style.display = 'none';
            document.getElementById('name-input-' + index).style.display = 'inline-block';
            document.getElementById('weight-display-' + index).style.display = 'none';
            document.getElementById('weight-input-' + index).style.display = 'inline-block';
            document.getElementById('edit-btn-' + index).style.display = 'none';
            document.getElementById('save-btn-' + index).style.display = 'inline-block';
            document.getElementById('cancel-btn-' + index).style.display = 'inline-block';
            document.getElementById('name-input-' + index).focus();
        }

        function cancelEdit(index) {
            document.getElementById('name-display-' + index).style.display = 'inline-block';
            document.getElementById('name-input-' + index).style.display = 'none';
            document.getElementById('weight-display-' + index).style.display = 'inline-block';
            document.getElementById('weight-input-' + index).style.display = 'none';
            document.getElementById('edit-btn-' + index).style.display = 'inline-block';
            document.getElementById('save-btn-' + index).style.display = 'none';
            document.getElementById('cancel-btn-' + index).style.display = 'none';
            document.getElementById('name-input-' + index).value = vendors[index].vendor;
            document.getElementById('weight-input-' + index).value = vendors[index].weight;
        }

        function saveVendor(index) {
            const newName = document.getElementById('name-input-' + index).value.trim();
            const newWeight = parseInt(document.getElementById('weight-input-' + index).value);

            if (!newName) {
                alert('è¯·è¾“å…¥å•†å®¶åç§°ï¼');
                return;
            }

            if (Number.isNaN(newWeight) || newWeight < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æƒé‡ï¼ˆå¤§äºç­‰äº0çš„æ•´æ•°ï¼‰ï¼');
                return;
            }

            fetch(API_URL + '/vendors/' + index, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ vendor: newName, weight: newWeight })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    originalVendors = data.vendors;
                    vendors = data.vendors;
                    applySortOrder();
                    renderVendorList();
                }
            })
            .catch(error => {
                console.error('Error updating vendor:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
            });
        }

        function changeSortOrder() {
            const sortSelect = document.getElementById('sortSelect');
            currentSortOrder = sortSelect.value;

            // ä¿å­˜æ’åºæ–¹å¼åˆ°localStorage
            localStorage.setItem('sortOrder', currentSortOrder);

            applySortOrder();
            renderVendorList();
        }

        function applySortOrder() {
            if (currentSortOrder === 'default') {
                // æ¢å¤åŸå§‹é¡ºåº
                vendors = [...originalVendors];
            } else if (currentSortOrder === 'name') {
                // æŒ‰åç§°æ’åºï¼ˆä¸­æ–‡æ‹¼éŸ³æ’åºï¼‰
                vendors = [...originalVendors].sort(function(a, b) {
                    return a.vendor.localeCompare(b.vendor, 'zh-CN');
                });
            } else if (currentSortOrder === 'weight') {
                // æŒ‰æƒé‡é™åºæ’åº
                vendors = [...originalVendors].sort(function(a, b) {
                    return b.weight - a.weight;
                });
            }
        }

        function randomSelect() {
            const resultDiv = document.getElementById('result');

            if (vendors.length === 0) {
                resultDiv.textContent = 'æ²¡æœ‰å¯é€‰æ‹©çš„å•†å®¶ï¼';
                return;
            }

            const totalWeight = vendors.reduce(function(sum, vendor) {
                return sum + vendor.weight;
            }, 0);

            if (totalWeight <= 0) {
                resultDiv.textContent = 'æƒé‡æ€»å’Œä¸º0ï¼Œæ— æ³•éšæœºé€‰æ‹©';
                return;
            }

            let random = Math.random() * totalWeight;

            for (let i = 0; i < vendors.length; i++) {
                random -= vendors[i].weight;
                if (random <= 0) {
                    resultDiv.textContent = 'ğŸ‰ ' + vendors[i].vendor;
                    return;
                }
            }

            resultDiv.textContent = 'ğŸ‰ ' + vendors[vendors.length - 1].vendor;
        }

        // ç‚¹é¤è®°å½•ç›¸å…³å‡½æ•°
        async function addMeal() {
            const dateInput = document.getElementById('mealDate');
            const orderInput = document.getElementById('mealOrder');
            const priceInput = document.getElementById('mealPrice');
            const rateInput = document.getElementById('mealRate');

            const date = dateInput.value.replace(/-/g, '').slice(2); // è½¬æ¢ä¸ºYYMMDDæ ¼å¼
            const order = orderInput.value.trim();
            const price = parseFloat(priceInput.value);
            const rate = parseInt(rateInput.value);

            if (!dateInput.value) {
                alert('è¯·é€‰æ‹©æ—¥æœŸï¼');
                return;
            }

            if (!order) {
                alert('è¯·è¾“å…¥ç‚¹é¤å†…å®¹ï¼');
                return;
            }

            if (isNaN(price) || price < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼');
                return;
            }

            if (isNaN(rate) || rate < 1 || rate > 5) {
                alert('è¯·è¾“å…¥1-5ä¹‹é—´çš„è¯„ä»·ï¼');
                return;
            }

            try {
                const response = await fetch(API_URL + '/meals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ date: date, order: order, price: price, rate: rate })
                });
                const data = await response.json();
                if (!response.ok || data.error) {
                    alert(data.error || 'æ·»åŠ å¤±è´¥');
                    return;
                }

                meals = data.meals;
                renderMealList();
                dateInput.value = '';
                orderInput.value = '';
                priceInput.value = '';
                rateInput.value = '3';
                orderInput.focus();
            } catch (error) {
                console.error('Error adding meal:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
            }
        }

        function renderMealList() {
            const listContainer = document.getElementById('mealList');

            if (meals.length === 0) {
                listContainer.innerHTML = '<div class="empty-message">æš‚æ— ç‚¹é¤è®°å½•</div>';
                return;
            }

            // åˆ›å»ºç´¢å¼•æ•°ç»„å¹¶æŒ‰æ—¥æœŸå€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const sortedIndices = meals.map(function(meal, idx) {
                return { meal: meal, originalIndex: idx };
            }).sort(function(a, b) {
                return b.meal.date.localeCompare(a.meal.date);
            });

            listContainer.innerHTML = sortedIndices.map(function(item) {
                const meal = item.meal;
                const index = item.originalIndex;
                const stars = 'â­'.repeat(meal.rate);
                const displayDate = '20' + meal.date.slice(0, 2) + '-' + meal.date.slice(2, 4) + '-' + meal.date.slice(4, 6);

                return '<div class="meal-item" id="meal-' + index + '">' +
                    '<span class="meal-date" id="meal-date-display-' + index + '">' + displayDate + '</span>' +
                    '<input type="date" class="date-edit-input" id="meal-date-input-' + index + '" value="20' + meal.date.slice(0, 2) + '-' + meal.date.slice(2, 4) + '-' + meal.date.slice(4, 6) + '" style="display: none;" />' +

                    '<span class="meal-order" id="meal-order-display-' + index + '">' + meal.order + '</span>' +
                    '<input type="text" class="order-edit-input" id="meal-order-input-' + index + '" value="' + meal.order + '" style="display: none;" />' +

                    '<span class="meal-price" id="meal-price-display-' + index + '">Â¥' + meal.price.toFixed(2) + '</span>' +
                    '<input type="number" class="price-edit-input" id="meal-price-input-' + index + '" value="' + meal.price + '" step="0.01" min="0" style="display: none;" />' +

                    '<span class="meal-rate" id="meal-rate-display-' + index + '">' + stars + '</span>' +
                    '<input type="number" class="rate-edit-input" id="meal-rate-input-' + index + '" value="' + meal.rate + '" min="1" max="5" style="display: none;" />' +

                    '<div class="meal-actions">' +
                    '<button class="edit-btn" id="meal-edit-btn-' + index + '" onclick="editMeal(' + index + ')">ç¼–è¾‘</button>' +
                    '<button class="save-btn" id="meal-save-btn-' + index + '" onclick="saveMeal(' + index + ')" style="display: none;">ä¿å­˜</button>' +
                    '<button class="cancel-btn" id="meal-cancel-btn-' + index + '" onclick="cancelEditMeal(' + index + ')" style="display: none;">å–æ¶ˆ</button>' +
                    '<button class="delete-btn" onclick="deleteMeal(' + index + ')">åˆ é™¤</button>' +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        function editMeal(index) {
            document.getElementById('meal-date-display-' + index).style.display = 'none';
            document.getElementById('meal-date-input-' + index).style.display = 'inline-block';
            document.getElementById('meal-order-display-' + index).style.display = 'none';
            document.getElementById('meal-order-input-' + index).style.display = 'inline-block';
            document.getElementById('meal-price-display-' + index).style.display = 'none';
            document.getElementById('meal-price-input-' + index).style.display = 'inline-block';
            document.getElementById('meal-rate-display-' + index).style.display = 'none';
            document.getElementById('meal-rate-input-' + index).style.display = 'inline-block';
            document.getElementById('meal-edit-btn-' + index).style.display = 'none';
            document.getElementById('meal-save-btn-' + index).style.display = 'inline-block';
            document.getElementById('meal-cancel-btn-' + index).style.display = 'inline-block';
        }

        function cancelEditMeal(index) {
            document.getElementById('meal-date-display-' + index).style.display = 'inline-block';
            document.getElementById('meal-date-input-' + index).style.display = 'none';
            document.getElementById('meal-order-display-' + index).style.display = 'inline-block';
            document.getElementById('meal-order-input-' + index).style.display = 'none';
            document.getElementById('meal-price-display-' + index).style.display = 'inline-block';
            document.getElementById('meal-price-input-' + index).style.display = 'none';
            document.getElementById('meal-rate-display-' + index).style.display = 'inline-block';
            document.getElementById('meal-rate-input-' + index).style.display = 'none';
            document.getElementById('meal-edit-btn-' + index).style.display = 'inline-block';
            document.getElementById('meal-save-btn-' + index).style.display = 'none';
            document.getElementById('meal-cancel-btn-' + index).style.display = 'none';

            const meal = meals[index];
            const displayDate = '20' + meal.date.slice(0, 2) + '-' + meal.date.slice(2, 4) + '-' + meal.date.slice(4, 6);
            document.getElementById('meal-date-input-' + index).value = displayDate;
            document.getElementById('meal-order-input-' + index).value = meal.order;
            document.getElementById('meal-price-input-' + index).value = meal.price;
            document.getElementById('meal-rate-input-' + index).value = meal.rate;
        }

        async function saveMeal(index) {
            const newDate = document.getElementById('meal-date-input-' + index).value.replace(/-/g, '').slice(2);
            const newOrder = document.getElementById('meal-order-input-' + index).value.trim();
            const newPrice = parseFloat(document.getElementById('meal-price-input-' + index).value);
            const newRate = parseInt(document.getElementById('meal-rate-input-' + index).value);

            if (!newDate) {
                alert('è¯·é€‰æ‹©æ—¥æœŸï¼');
                return;
            }

            if (!newOrder) {
                alert('è¯·è¾“å…¥ç‚¹é¤å†…å®¹ï¼');
                return;
            }

            if (isNaN(newPrice) || newPrice < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼');
                return;
            }

            if (isNaN(newRate) || newRate < 1 || newRate > 5) {
                alert('è¯·è¾“å…¥1-5ä¹‹é—´çš„è¯„ä»·ï¼');
                return;
            }

            try {
                const response = await fetch(API_URL + '/meals/' + index, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ date: newDate, order: newOrder, price: newPrice, rate: newRate })
                });

                const data = await response.json();
                if (!response.ok || data.error) {
                    alert(data.error || 'æ›´æ–°å¤±è´¥');
                    return;
                }

                meals = data.meals;
                renderMealList();
            } catch (error) {
                console.error('Error updating meal:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
            }
        }

        function deleteMeal(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç‚¹é¤è®°å½•å—ï¼Ÿ')) {
                fetch(API_URL + '/meals/' + index, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        meals = data.meals;
                        renderMealList();
                    }
                })
                .catch(error => {
                    console.error('Error deleting meal:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼');
                });
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            loadData();

            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('mealDate').value = today;

            document.getElementById('vendorName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addVendor();
                }
            });

            document.getElementById('vendorWeight').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addVendor();
                }
            });

            document.getElementById('mealOrder').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMeal();
                }
            });

            document.getElementById('mealPrice').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMeal();
                }
            });

            document.getElementById('mealRate').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMeal();
                }
            });
        });
    </script>
</body>
</html>
